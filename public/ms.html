<!DOCTYPE html>
<html>
<head>
	<title>Test Heat Map</title>
	<meta charset="utf-8" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	
	<!--[if lte IE 8]><link rel="stylesheet" href="../dist/leaflet.ie.css" /><![endif]-->

	<style>
	
#map {
  width: 960px;
  height: 1500px;
}


	</style>
</head>
<body>
	<div id="map"></div>



  <link rel="stylesheet" href="https://npmcdn.com/leaflet@0.7.7/dist/leaflet.css" />
  <script src="https://npmcdn.com/leaflet@0.7.7/dist/leaflet.js"></script>  
  <script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.2.1"></script>
  <script src="http://code.jquery.com/jquery-1.10.0.js"></script>
	<script src="http://d3js.org/d3.v3.min.js"></script>
	<script src="js/marchingsquares-isobands.min.js"></script>
	<script src="js/cubehelix.js"></script>
  
  
  
	<script type="text/javascript">

  var layer = new L.StamenTileLayer("toner");

  var map = new L.Map("map", {
        center: [43, -120],
        zoom: 7
      })
      .addLayer(layer);
  map._initPathRoot();
  
  
  var svg = d3.select("#map").select("svg");
  var g = svg.append("g").attr("class", "leaflet-zoom-hide").attr('opacity', 0.8);
  
  var defaultContourColor = 'black';
  var defaultContourWidth = 1;

  
  var colors = d3.scale.cubehelix().domain([0, 11]);
  
  d3.json("js/grid3.json", function(data) {
    // zs = [-0.5, -0.75, 0, 0.25, 0.5, 0.75, 1.0, 1.25, 1.5, 1.75, 2.0, 2.25, 2.5, 2.75, 3.0 ];
    
    
    zs = [0, 4.5, 9, 13.5, 18];
    data = [[18, 13, 10, 9, 10, 13, 18],
        [13, 8, 5, 4, 5, 8, 13],
        [10, 5, 2, 1, 2, 5, 10],
        [9, 4, 1, 12, 1, 4, 9],
        [10, 5, 2, 1, 2, 5, 10],
        [13, 8, 5, 4, 5, 8, 13],
        [18, 13, 10, 9, 10, 13, 18],
        [18, 13, 10, 9, 10, 13, 18]]

        data = d3.transpose(data);
        

        var xs = d3.range(0, data[0].length);
        var ys = d3.range(0, data.length);

        var marginBottomLabel = 0;

        var width = 250
        var height = width * (ys.length / xs.length);

        xScale = d3.scale.linear()
        .range([0, width])
        .domain([Math.min.apply(null, xs), Math.max.apply(null, xs)])

        yScale = d3.scale.linear()
        .range([0, height])
        .domain([Math.min.apply(null, ys), Math.max.apply(null, ys)])

        var colours = d3.scale.linear().domain([zs[0], zs[zs.length - 1]])
        .range([d3.rgb(0,0,0),
               d3.rgb(200,200,200)]);

        var isoBands = [];
        for (var i = 1; i < zs.length; i++) {
            var lowerBand = zs[i-1];
            var upperBand = zs[i];

            var band = MarchingSquaresJS.IsoBands(data, lowerBand, upperBand - lowerBand);
            console.log('band', band);
            isoBands.push({"coords": band, "level": i, "val": zs[i]});
        }
        // console.log(isoBands)

        /*
        svg.append('text')
        .attr('transform', 'translate(' + (width/2) + ','+(height+15)+')')
        .attr('text-anchor', 'middle')
        .text("MarchingSquares.js");
        */
      var contourPath = g.selectAll("path")        
        .data(isoBands)
        .enter().append("path")
        .style("fill",function(d) { return colours(d.val);})
        .style("stroke","black")
        .style('opacity', 1.0);
        
          map.on("viewreset", reset);

          reset();  


          function reset() {
            contourPath.attr("d", function(d) {
              var p = "";
              d.coords.forEach(function(aa, i){
                  p += (d3.svg.line()
                        .x(function(dat){ return xScale(dat[0]); })
                        .y(function(dat){ return yScale(dat[1]); })
                        .interpolate("linear")
                       )(aa) + "Z";
              });
              return p;
            });

          }
          function projectPoint(x, y) {
              var point = map.latLngToLayerPoint(new L.LatLng(y, x));
              this.stream.point(point.x, point.y);
          } 

  

      
  });

	</script>
</body>
</html>
